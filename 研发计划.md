# AgentScope.NET è¯¦å°½ç ”å‘è®¡åˆ’

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-18  
> **å½“å‰è¿›åº¦**: 29/54 (53.7%)  
> **ç›®æ ‡**: å®Œæ•´1:1å¤åˆ»agentscope-javaåˆ°.NETå¹³å°

---

## ğŸ“‘ ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆä¸è®¾è®¡å“²å­¦](#1-é¡¹ç›®æ¦‚è§ˆä¸è®¾è®¡å“²å­¦)
2. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#2-ç³»ç»Ÿæ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#3-æ ¸å¿ƒè®¾è®¡åŸåˆ™)
4. [æŠ€æœ¯æ ˆä¸å·¥å…·é“¾](#4-æŠ€æœ¯æ ˆä¸å·¥å…·é“¾)
5. [54ä¸ªåŠŸèƒ½ç‚¹è¯¦ç»†è§„åˆ’](#5-54ä¸ªåŠŸèƒ½ç‚¹è¯¦ç»†è§„åˆ’)
6. [åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#6-åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
7. [è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ](#7-è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ)
8. [è´¨é‡ä¿è¯ç­–ç•¥](#8-è´¨é‡ä¿è¯ç­–ç•¥)
9. [é£é™©ç®¡ç†](#9-é£é™©ç®¡ç†)
10. [é™„å½•](#10-é™„å½•)

---

## 1. é¡¹ç›®æ¦‚è§ˆä¸è®¾è®¡å“²å­¦

### 1.1 é¡¹ç›®æ„¿æ™¯

**AgentScope.NET** æ—¨åœ¨æˆä¸º.NETå¹³å°ä¸Šæœ€å¼ºå¤§ã€æœ€æ˜“ç”¨çš„å¤šæ™ºèƒ½ä½“æ¡†æ¶ï¼Œå®ç°ä¸agentscope-javaå®Œå…¨åŠŸèƒ½å¯¹ç­‰ï¼ŒåŒæ—¶å……åˆ†åˆ©ç”¨C#å’Œ.NETç”Ÿæ€çš„ä¼˜åŠ¿ã€‚

**æ ¸å¿ƒç†å¿µ**:
- ğŸ¯ **åŠŸèƒ½å¯¹ç­‰**: ä¸Javaç‰ˆæœ¬100%åŠŸèƒ½å¯¹åº”
- ğŸ—ï¸ **æ¶æ„ä¼˜é›…**: å……åˆ†åˆ©ç”¨C#è¯­è¨€ç‰¹æ€§
- ğŸ”§ **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ’ä»¶åŒ–æ¶æ„
- ğŸ“š **å®Œæ•´æ–‡æ¡£**: ä¸­è‹±æ–‡åŒè¯­ï¼Œè¯¦å°½æ³¨é‡Š
- âœ… **é«˜è´¨é‡**: 80%+æµ‹è¯•è¦†ç›–ï¼Œé›¶æŠ€æœ¯å€º

### 1.2 è®¾è®¡å“²å­¦

#### 1.2.1 æ¶æ„ç†å¿µ

**åˆ†å±‚æ¶æ„ (Layered Architecture)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚ (Application Layer)          â”‚
â”‚  - Uno GUI                                   â”‚
â”‚  - Terminal.Gui TUI                          â”‚
â”‚  - ç¤ºä¾‹åº”ç”¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æœåŠ¡å±‚ (Service Layer)              â”‚
â”‚  - Agent ç¼–æ’                                â”‚
â”‚  - Pipeline ç®¡ç†                             â”‚
â”‚  - Plan æ‰§è¡Œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ ¸å¿ƒå±‚ (Core Layer)                 â”‚
â”‚  - Agent ç³»ç»Ÿ                                â”‚
â”‚  - Hook ç³»ç»Ÿ                                 â”‚
â”‚  - Memory ç®¡ç†                               â”‚
â”‚  - Message ç³»ç»Ÿ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)    â”‚
â”‚  - Formatter (OpenAI, Anthropic, etc.)      â”‚
â”‚  - Model (LLM é›†æˆ)                         â”‚
â”‚  - Tool ç³»ç»Ÿ                                 â”‚
â”‚  - Storage (SQLite)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2.2 è®¾è®¡åŸåˆ™

**SOLID åŸåˆ™**:
- **S** - Single Responsibility: æ¯ä¸ªç±»å•ä¸€èŒè´£
- **O** - Open/Closed: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **L** - Liskov Substitution: å­ç±»å¯æ›¿æ¢çˆ¶ç±»
- **I** - Interface Segregation: æ¥å£éš”ç¦»ï¼Œç²¾ç®€æ¥å£
- **D** - Dependency Inversion: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

**DRY (Don't Repeat Yourself)**:
- æå–å…¬å…±ä»£ç åˆ°åŸºç±»
- ä½¿ç”¨æ³›å‹å‡å°‘é‡å¤
- å·¥å…·ç±»å°è£…å¸¸ç”¨åŠŸèƒ½

**KISS (Keep It Simple, Stupid)**:
- ä¼˜å…ˆç®€å•è§£å†³æ–¹æ¡ˆ
- é¿å…è¿‡åº¦è®¾è®¡
- æ¸…æ™°èƒœäºèªæ˜

#### 1.2.3 C# è¯­è¨€ç‰¹æ€§åˆ©ç”¨

**ç°ä»£ C# ç‰¹æ€§**:
```csharp
// 1. Record ç±»å‹ï¼ˆä¸å¯å˜æ•°æ®ï¼‰
public record Msg(string Role, string Content, 
    Dictionary<string, object>? Metadata = null);

// 2. æ¨¡å¼åŒ¹é…
var result = message switch
{
    { Role: "system" } => ConvertSystemMessage(message),
    { Role: "user" } => ConvertUserMessage(message),
    { Role: "assistant" } => ConvertAssistantMessage(message),
    _ => throw new ArgumentException("Unknown role")
};

// 3. Nullable å¼•ç”¨ç±»å‹
public string? OptionalProperty { get; init; }

// 4. å¼‚æ­¥æµ
public async IAsyncEnumerable<string> StreamResponse()
{
    await foreach (var chunk in GetChunks())
    {
        yield return chunk;
    }
}

// 5. LINQ å’Œæ‰©å±•æ–¹æ³•
var tools = messages
    .Where(m => m.Role == "assistant")
    .SelectMany(m => m.ToolCalls ?? Enumerable.Empty<ToolCall>())
    .ToList();
```

### 1.3 ä¸ Java ç‰ˆæœ¬çš„å·®å¼‚å¤„ç†

#### 1.3.1 è¯­è¨€å·®å¼‚æ˜ å°„

| Java | C# | è¯´æ˜ |
|------|-----|------|
| `Optional<T>` | `T?` (Nullable) | å¯é€‰å€¼å¤„ç† |
| `Stream API` | LINQ | é›†åˆæ“ä½œ |
| `CompletableFuture` | `Task<T>` | å¼‚æ­¥ç¼–ç¨‹ |
| `@Lombok` | record ç±»å‹ | æ•°æ®ç±» |
| `instanceof` | is/as è¿ç®—ç¬¦ | ç±»å‹æ£€æŸ¥ |
| `Jackson` | System.Text.Json | JSONåºåˆ—åŒ– |

#### 1.3.2 è®¾è®¡é€‚é…ç­–ç•¥

**ä¿æŒä¸€è‡´**:
- ç±»åå’Œæ¥å£åå¯¹åº”
- æ–¹æ³•ç­¾ååŠŸèƒ½å¯¹ç­‰
- é…ç½®æ ¼å¼å…¼å®¹

**C# ä¼˜åŒ–**:
- ä½¿ç”¨ async/await æ›¿ä»£ CompletableFuture
- ä½¿ç”¨ IAsyncEnumerable æ›¿ä»£ Flux
- ä½¿ç”¨ record æ›¿ä»£ Lombok
- ä½¿ç”¨ LINQ æ›¿ä»£ Stream API

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚ (Apps)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Uno GUI        â”‚  Terminal.Gui    â”‚   ç¤ºä¾‹åº”ç”¨               â”‚
â”‚   (è·¨å¹³å°GUI)     â”‚   (TUI)          â”‚   (QuickStartç­‰)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentScope.Core                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚   Agent     â”‚ â”‚    Hook     â”‚ â”‚   Session    â”‚            â”‚
â”‚ â”‚   System    â”‚ â”‚   System    â”‚ â”‚   ç®¡ç†       â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚   Memory    â”‚ â”‚   Message   â”‚ â”‚   Pipeline   â”‚            â”‚
â”‚ â”‚   System    â”‚ â”‚   System    â”‚ â”‚   ç¼–æ’       â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚    Plan     â”‚ â”‚     RAG     â”‚ â”‚   Tracing    â”‚            â”‚
â”‚ â”‚   ç®¡ç†      â”‚ â”‚   System    â”‚ â”‚   è¿½è¸ª       â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚  Formatter  â”‚ â”‚    Model    â”‚ â”‚    Tool      â”‚            â”‚
â”‚ â”‚  (å¤šLLM)    â”‚ â”‚  (LLMé›†æˆ)  â”‚ â”‚   System     â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚   Storage   â”‚ â”‚    Config   â”‚ â”‚  Exception   â”‚            â”‚
â”‚ â”‚  (SQLite)   â”‚ â”‚  (.env)     â”‚ â”‚   å¤„ç†       â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—æ¶æ„

#### 2.2.1 Agent ç³»ç»Ÿæ¶æ„

**ç±»å±‚æ¬¡ç»“æ„**:
```
IAgent (æ¥å£)
    â†‘
AgentBase (æŠ½è±¡åŸºç±»)
    â†‘
    â”œâ”€â”€ EnhancedReActAgent
    â”œâ”€â”€ CallableAgent
    â”œâ”€â”€ ObservableAgent
    â”œâ”€â”€ StreamableAgent
    â”œâ”€â”€ StructuredOutputCapableAgent
    â””â”€â”€ UserAgent
```

**èŒè´£åˆ’åˆ†**:
- **IAgent**: å®šä¹‰Agentæ ‡å‡†æ¥å£
  - `CallAsync(Msg msg)`: å¤„ç†æ¶ˆæ¯
  - `Name`: Agentåç§°
  - `Model`: å…³è”çš„LLMæ¨¡å‹

- **AgentBase**: æä¾›é€šç”¨å®ç°
  - Memoryç®¡ç†
  - Hookè§¦å‘
  - é”™è¯¯å¤„ç†
  - æ—¥å¿—è®°å½•

- **EnhancedReActAgent**: å®Œæ•´ReActå¾ªç¯
  - æ¨ç†ï¼ˆReasoningï¼‰
  - è¡ŒåŠ¨ï¼ˆActingï¼‰
  - å·¥å…·æ‰§è¡Œ
  - è¿­ä»£æ§åˆ¶

#### 2.2.2 Formatter ç³»ç»Ÿæ¶æ„

**æŠ½è±¡å·¥å‚æ¨¡å¼**:
```
IFormatter<TRequest, TResponse, TParams>
    â†‘
FormatterBase<TRequest, TResponse, TParams>
    â†‘
    â”œâ”€â”€ OpenAIFormatter
    â”‚   â”œâ”€â”€ OpenAIChatFormatter
    â”‚   â””â”€â”€ OpenAICompletionFormatter
    â”œâ”€â”€ AnthropicFormatter
    â”œâ”€â”€ DashScopeFormatter
    â””â”€â”€ OllamaFormatter
```

**ç»„ä»¶åä½œ**:
```
MessageConverter â†’ Formatter â†’ ResponseParser
       â†“              â†“              â†“
   Msgå¯¹è±¡      APIè¯·æ±‚æ ¼å¼     è§£æåå“åº”
```

#### 2.2.3 Pipeline ç³»ç»Ÿæ¶æ„

**ç»„åˆæ¨¡å¼**:
```
IPipeline
    â†‘
    â”œâ”€â”€ SequentialPipeline (é¡ºåºæ‰§è¡Œ)
    â”œâ”€â”€ ParallelPipeline (å¹¶è¡Œæ‰§è¡Œ)
    â””â”€â”€ ConditionalPipeline (æ¡ä»¶æ‰§è¡Œ)
```

**æ‰§è¡Œæµç¨‹**:
```
Input Message
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pipeline Start  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent 1 å¤„ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent 2 å¤„ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pipeline End   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Output Message
```

### 2.3 æ•°æ®æµè®¾è®¡

#### 2.3.1 æ¶ˆæ¯æµ

```
User Input
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Msg Builder â”‚ (æ„å»ºæ¶ˆæ¯å¯¹è±¡)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent     â”‚ (å¤„ç†æ¶ˆæ¯)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Formatter  â”‚ (æ ¼å¼åŒ–ä¸ºLLMè¯·æ±‚)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM API    â”‚ (è°ƒç”¨LLM)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Parser    â”‚ (è§£æå“åº”)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Response   â”‚ (è¿”å›ç»“æœ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.2 å·¥å…·è°ƒç”¨æµ

```
Agent Decision
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool Request â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool Execute â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool Result  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Agent Continue
```

---

## 3. æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 3.1 æ¥å£è®¾è®¡åŸåˆ™

**æ¥å£èŒè´£å•ä¸€**:
```csharp
// å¥½çš„è®¾è®¡ï¼šèŒè´£å•ä¸€
public interface IModel
{
    Task<string> GenerateAsync(string prompt);
}

public interface IStreamableModel
{
    IAsyncEnumerable<string> StreamAsync(string prompt);
}

// é¿å…ï¼šèŒè´£æ··æ‚
// public interface IModel
// {
//     Task<string> GenerateAsync(string prompt);
//     IAsyncEnumerable<string> StreamAsync(string prompt);
//     void SaveToFile(string path);  // âŒ ä¸å±äºModelèŒè´£
// }
```

**ä¾èµ–æŠ½è±¡è€Œéå…·ä½“**:
```csharp
// å¥½çš„è®¾è®¡
public class Agent
{
    private readonly IModel _model;  // ä¾èµ–æ¥å£
    
    public Agent(IModel model)
    {
        _model = model;
    }
}

// é¿å…
// public class Agent
// {
//     private readonly OpenAIModel _model;  // âŒ ä¾èµ–å…·ä½“ç±»
// }
```

### 3.2 å¼‚æ­¥ç¼–ç¨‹åŸåˆ™

**å¼‚æ­¥ä¼˜å…ˆ**:
```csharp
// æ‰€æœ‰I/Oæ“ä½œä½¿ç”¨å¼‚æ­¥
public async Task<Msg> CallAsync(Msg message)
{
    // 1. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆI/Oï¼‰
    await _memory.AddAsync(message);
    
    // 2. è°ƒç”¨LLMï¼ˆç½‘ç»œI/Oï¼‰
    var response = await _model.GenerateAsync(message.Content);
    
    // 3. ä¿å­˜å“åº”ï¼ˆI/Oï¼‰
    var result = Msg.Builder()
        .Role("assistant")
        .Content(response)
        .Build();
    await _memory.AddAsync(result);
    
    return result;
}
```

**æµå¼å“åº”**:
```csharp
// ä½¿ç”¨ IAsyncEnumerable å®ç°æµå¼
public async IAsyncEnumerable<string> StreamResponseAsync(
    Msg message,
    [EnumeratorCancellation] CancellationToken ct = default)
{
    await foreach (var chunk in _model.StreamAsync(message.Content).WithCancellation(ct))
    {
        yield return chunk;
    }
}
```

### 3.3 é”™è¯¯å¤„ç†åŸåˆ™

**å¼‚å¸¸å±‚æ¬¡**:
```csharp
AgentScopeException (åŸºç¡€å¼‚å¸¸)
    â”œâ”€â”€ AgentException (Agentç›¸å…³)
    â”œâ”€â”€ ModelException (Modelç›¸å…³)
    â”‚   â”œâ”€â”€ ModelNotFoundException
    â”‚   â”œâ”€â”€ ModelTimeoutException
    â”‚   â””â”€â”€ ModelQuotaExceededException
    â”œâ”€â”€ MemoryException (Memoryç›¸å…³)
    â”œâ”€â”€ ToolException (Toolç›¸å…³)
    â””â”€â”€ FormatterException (Formatterç›¸å…³)
```

**é”™è¯¯å¤„ç†æ¨¡å¼**:
```csharp
public async Task<Msg> CallAsync(Msg message)
{
    try
    {
        // è§¦å‘ Pre Hook
        await TriggerHooksAsync(HookEvent.PreReasoning, message);
        
        // æ‰§è¡Œæ ¸å¿ƒé€»è¾‘
        var response = await ProcessMessageAsync(message);
        
        // è§¦å‘ Post Hook
        await TriggerHooksAsync(HookEvent.PostReasoning, response);
        
        return response;
    }
    catch (ModelException ex)
    {
        _logger.LogError(ex, "Model error in agent {AgentName}", Name);
        throw;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Unexpected error in agent {AgentName}", Name);
        throw new AgentException($"Error in agent {Name}", ex);
    }
}
```

### 3.4 å†…å­˜ç®¡ç†åŸåˆ™

**ä½¿ç”¨ IDisposable**:
```csharp
public class SqliteMemory : IMemory, IDisposable
{
    private readonly MemoryDbContext _context;
    private bool _disposed;
    
    public void Dispose()
    {
        if (!_disposed)
        {
            _context?.Dispose();
            _disposed = true;
        }
    }
}
```

**ä½¿ç”¨ ObjectPool ä¼˜åŒ–æ€§èƒ½**:
```csharp
// å¯¹äºé¢‘ç¹åˆ›å»ºçš„å¯¹è±¡ä½¿ç”¨å¯¹è±¡æ± 
private static readonly ObjectPool<StringBuilder> StringBuilderPool = 
    new DefaultObjectPool<StringBuilder>(new StringBuilderPooledObjectPolicy());

public string BuildString()
{
    var sb = StringBuilderPool.Get();
    try
    {
        sb.Append("...");
        return sb.ToString();
    }
    finally
    {
        StringBuilderPool.Return(sb);
    }
}
```

---

## 4. æŠ€æœ¯æ ˆä¸å·¥å…·é“¾

### 4.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| è¿è¡Œæ—¶ | .NET | 9.0 | æ ¸å¿ƒæ¡†æ¶ |
| è¯­è¨€ | C# | 12.0 | ç¼–ç¨‹è¯­è¨€ |
| æ•°æ®åº“ | SQLite | 3.x | æœ¬åœ°å­˜å‚¨ |
| ORM | EF Core | 9.0 | æ•°æ®è®¿é—® |
| JSON | System.Text.Json | - | JSONåºåˆ—åŒ– |
| å“åº”å¼ | System.Reactive | 6.x | å“åº”å¼ç¼–ç¨‹ |
| æµ‹è¯• | xUnit | 2.x | å•å…ƒæµ‹è¯• |
| GUI | Uno Platform | 5.6 | è·¨å¹³å°GUI |
| TUI | Terminal.Gui | 2.0 | ç»ˆç«¯ç•Œé¢ |

### 4.2 å¼€å‘å·¥å…·

| å·¥å…· | ç”¨é€” |
|------|------|
| Visual Studio 2022 / VS Code | IDE |
| dotnet CLI | å‘½ä»¤è¡Œå·¥å…· |
| Git | ç‰ˆæœ¬æ§åˆ¶ |
| GitHub Actions | CI/CD |
| SonarQube | ä»£ç è´¨é‡åˆ†æ |
| Benchmark.NET | æ€§èƒ½æµ‹è¯• |

### 4.3 NuGet åŒ…ä¾èµ–

**æ ¸å¿ƒåŒ…**:
```xml
<ItemGroup>
  <!-- æ ¸å¿ƒæ¡†æ¶ -->
  <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.0" />
  <PackageReference Include="Microsoft.Extensions.Logging" Version="9.0.0" />
  <PackageReference Include="Microsoft.Extensions.Configuration" Version="9.0.0" />
  
  <!-- æ•°æ®åº“ -->
  <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="9.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.0" />
  
  <!-- JSON -->
  <PackageReference Include="System.Text.Json" Version="9.0.0" />
  <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  
  <!-- å“åº”å¼ -->
  <PackageReference Include="System.Reactive" Version="6.0.0" />
  
  <!-- é…ç½® -->
  <PackageReference Include="DotNetEnv" Version="3.0.0" />
  
  <!-- HTTP -->
  <PackageReference Include="Microsoft.Extensions.Http" Version="9.0.0" />
</ItemGroup>
```

**æµ‹è¯•åŒ…**:
```xml
<ItemGroup>
  <PackageReference Include="xUnit" Version="2.6.0" />
  <PackageReference Include="xUnit.runner.visualstudio" Version="2.5.0" />
  <PackageReference Include="Moq" Version="4.20.0" />
  <PackageReference Include="FluentAssertions" Version="6.12.0" />
</ItemGroup>
```

---

## 5. 54ä¸ªåŠŸèƒ½ç‚¹è¯¦ç»†è§„åˆ’

### ğŸ“¦ åŠŸèƒ½ç‚¹1-10ï¼šAgent ç³»ç»ŸåŸºç¡€

#### [åŠŸèƒ½ç‚¹1] AgentBase åŸºç±» âœ…

**çŠ¶æ€**: å·²å®Œæˆ  
**æ–‡ä»¶**: `src/AgentScope.Core/Agent/AgentBase.cs`

**è®¾è®¡è¦ç‚¹**:
- æä¾›æ‰€æœ‰Agentçš„é€šç”¨åŠŸèƒ½
- ç®¡ç†Memoryã€Modelã€Tools
- å®ç°Hookè§¦å‘æœºåˆ¶
- å¤„ç†å¼‚å¸¸å’Œæ—¥å¿—

**ä»£ç ç»“æ„**:
```csharp
public abstract class AgentBase : IAgent
{
    protected readonly IModel _model;
    protected readonly IMemory _memory;
    protected readonly IList<ITool> _tools;
    protected readonly HookManager _hookManager;
    
    public string Name { get; protected set; }
    
    public abstract Task<Msg> CallAsync(Msg message);
    
    protected async Task TriggerHooksAsync(HookEvent hookEvent, object data)
    {
        // Hookè§¦å‘é€»è¾‘
    }
}
```

---

#### [åŠŸèƒ½ç‚¹2] EnhancedReActAgent å®Œæ•´å®ç° âœ…

**çŠ¶æ€**: å·²å®Œæˆ  
**æ–‡ä»¶**: `src/AgentScope.Core/EnhancedReActAgent.cs`

**è®¾è®¡æ€æƒ³**:
- å®ç°å®Œæ•´çš„ReAct (Reasoning + Acting) å¾ªç¯
- æ”¯æŒå·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
- æ§åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°
- é›†æˆHookç³»ç»Ÿ

**æ ¸å¿ƒæµç¨‹**:
```
1. Reasoningï¼ˆæ¨ç†ï¼‰
   â†“
2. Actingï¼ˆè¡ŒåŠ¨å†³ç­–ï¼‰
   â†“
3. Tool Executionï¼ˆå·¥å…·æ‰§è¡Œï¼‰
   â†“
4. Observationï¼ˆè§‚å¯Ÿç»“æœï¼‰
   â†“
5. åˆ¤æ–­æ˜¯å¦ç»§ç»­å¾ªç¯
```

**å…³é”®å®ç°**:
```csharp
public class EnhancedReActAgent : AgentBase
{
    private readonly int _maxIterations;
    
    public override async Task<Msg> CallAsync(Msg message)
    {
        var iteration = 0;
        var thoughtHistory = new List<string>();
        
        while (iteration < _maxIterations)
        {
            // 1. Reasoning
            await TriggerHooksAsync(HookEvent.PreReasoning, message);
            var thought = await ReasonAsync(message, thoughtHistory);
            await TriggerHooksAsync(HookEvent.PostReasoning, thought);
            
            // 2. Acting
            await TriggerHooksAsync(HookEvent.PreActing, thought);
            var action = await DecideActionAsync(thought);
            await TriggerHooksAsync(HookEvent.PostActing, action);
            
            // 3. åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·è°ƒç”¨
            if (action.IsToolCall)
            {
                var toolResult = await ExecuteToolAsync(action.ToolName, action.Parameters);
                thoughtHistory.Add($"Tool {action.ToolName}: {toolResult}");
                iteration++;
            }
            else
            {
                // è¿”å›æœ€ç»ˆç­”æ¡ˆ
                return action.Response;
            }
        }
        
        // è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
        return BuildMaxIterationResponse(thoughtHistory);
    }
}
```

---

#### [åŠŸèƒ½ç‚¹3] CallableAgent å®ç°

**çŠ¶æ€**: å¾…å®ç°  
**ä¼˜å…ˆçº§**: ä¸­  
**å·¥æ—¶**: 1å¤©  
**ä¾èµ–**: AgentBase

**è®¾è®¡ç›®æ ‡**:
- å¯è¢«å…¶ä»–Agentè°ƒç”¨çš„Agent
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨
- æä¾›æ¸…æ™°çš„è¾“å…¥è¾“å‡ºæ¥å£

**å®æ–½æ­¥éª¤**:

1. **å®šä¹‰æ¥å£** (0.5h)
```csharp
public interface ICallableAgent : IAgent
{
    /// <summary>
    /// åŒæ­¥è°ƒç”¨ï¼ˆå†…éƒ¨ä½¿ç”¨asyncï¼‰
    /// </summary>
    Msg Call(Msg message);
    
    /// <summary>
    /// å¼‚æ­¥è°ƒç”¨
    /// </summary>
    Task<Msg> CallAsync(Msg message);
    
    /// <summary>
    /// æ‰¹é‡è°ƒç”¨
    /// </summary>
    Task<IList<Msg>> CallBatchAsync(IList<Msg> messages);
}
```

2. **å®ç°åŸºç±»** (2h)
```csharp
public class CallableAgent : AgentBase, ICallableAgent
{
    public Msg Call(Msg message)
    {
        return CallAsync(message).GetAwaiter().GetResult();
    }
    
    public override async Task<Msg> CallAsync(Msg message)
    {
        // éªŒè¯è¾“å…¥
        ValidateInput(message);
        
        // æ·»åŠ åˆ°å†…å­˜
        await _memory.AddAsync(message);
        
        // è°ƒç”¨æ¨¡å‹
        var response = await _model.GenerateAsync(
            FormatPrompt(message));
        
        // æ„å»ºå“åº”
        var result = Msg.Builder()
            .Role("assistant")
            .Name(Name)
            .Content(response)
            .Build();
        
        // ä¿å­˜å“åº”
        await _memory.AddAsync(result);
        
        return result;
    }
    
    public async Task<IList<Msg>> CallBatchAsync(IList<Msg> messages)
    {
        var results = new List<Msg>();
        foreach (var msg in messages)
        {
            results.Add(await CallAsync(msg));
        }
        return results;
    }
    
    private void ValidateInput(Msg message)
    {
        if (string.IsNullOrEmpty(message.Content))
            throw new AgentException("Message content cannot be empty");
    }
    
    private string FormatPrompt(Msg message)
    {
        // ä»Memoryè·å–ä¸Šä¸‹æ–‡
        var context = _memory.GetRecent(10);
        
        // æ„å»ºå®Œæ•´æç¤º
        var prompt = new StringBuilder();
        foreach (var msg in context)
        {
            prompt.AppendLine($"{msg.Role}: {msg.Content}");
        }
        prompt.AppendLine($"{message.Role}: {message.Content}");
        
        return prompt.ToString();
    }
}
```

3. **Builderæ¨¡å¼** (1h)
```csharp
public class CallableAgentBuilder
{
    private string? _name;
    private IModel? _model;
    private IMemory? _memory;
    private string? _sysPrompt;
    
    public CallableAgentBuilder Name(string name)
    {
        _name = name;
        return this;
    }
    
    public CallableAgentBuilder Model(IModel model)
    {
        _model = model;
        return this;
    }
    
    public CallableAgentBuilder Memory(IMemory memory)
    {
        _memory = memory;
        return this;
    }
    
    public CallableAgentBuilder SysPrompt(string prompt)
    {
        _sysPrompt = prompt;
        return this;
    }
    
    public CallableAgent Build()
    {
        if (_model == null)
            throw new ArgumentException("Model is required");
        
        return new CallableAgent
        {
            Name = _name ?? "CallableAgent",
            Model = _model,
            Memory = _memory ?? new MemoryBase(),
            SystemPrompt = _sysPrompt ?? "You are a helpful assistant."
        };
    }
}
```

4. **å•å…ƒæµ‹è¯•** (2h)
```csharp
public class CallableAgentTests
{
    [Fact]
    public async Task CallAsync_WithValidMessage_ReturnsResponse()
    {
        // Arrange
        var mockModel = new MockModel();
        var agent = CallableAgent.Builder()
            .Name("TestAgent")
            .Model(mockModel)
            .Build();
        
        var message = Msg.Builder()
            .Role("user")
            .Content("Hello")
            .Build();
        
        // Act
        var response = await agent.CallAsync(message);
        
        // Assert
        Assert.NotNull(response);
        Assert.Equal("assistant", response.Role);
        Assert.NotEmpty(response.Content);
    }
    
    [Fact]
    public async Task CallBatchAsync_WithMultipleMessages_ReturnsMultipleResponses()
    {
        // Arrange
        var agent = CallableAgent.Builder()
            .Model(new MockModel())
            .Build();
        
        var messages = new List<Msg>
        {
            Msg.Builder().Role("user").Content("Message 1").Build(),
            Msg.Builder().Role("user").Content("Message 2").Build(),
        };
        
        // Act
        var responses = await agent.CallBatchAsync(messages);
        
        // Assert
        Assert.Equal(2, responses.Count);
    }
    
    [Fact]
    public async Task CallAsync_WithEmptyContent_ThrowsException()
    {
        // Arrange
        var agent = CallableAgent.Builder()
            .Model(new MockModel())
            .Build();
        
        var message = Msg.Builder()
            .Role("user")
            .Content("")
            .Build();
        
        // Act & Assert
        await Assert.ThrowsAsync<AgentException>(
            () => agent.CallAsync(message));
    }
}
```

5. **éªŒæ”¶æ ‡å‡†**
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡ >= 80%
- [ ] æ„å»ºæ— è­¦å‘Š
- [ ] ä¸Javaç‰ˆæœ¬åŠŸèƒ½å¯¹ç­‰
- [ ] å®Œæ•´çš„XMLæ³¨é‡Š
- [ ] ç¤ºä¾‹ä»£ç è¿è¡Œæ­£å¸¸

6. **Javaæºç å‚è€ƒ**
- `core/agent/CallableAgent.java`
- è¡Œæ•°ï¼šçº¦150è¡Œ
- å…³é”®æ–¹æ³•ï¼šcall(), callAsync()

---

#### [åŠŸèƒ½ç‚¹4] ObservableAgent å®ç°

**çŠ¶æ€**: å¾…å®ç°  
**ä¼˜å…ˆçº§**: ä¸­  
**å·¥æ—¶**: 1å¤©  
**ä¾èµ–**: AgentBase, System.Reactive

**è®¾è®¡ç›®æ ‡**:
- å®ç°è§‚å¯Ÿè€…æ¨¡å¼
- å…è®¸è®¢é˜…Agentçš„çŠ¶æ€å˜åŒ–
- æ”¯æŒäº‹ä»¶æµï¼ˆEvent Streamï¼‰

**å®æ–½æ­¥éª¤**:

1. **å®šä¹‰äº‹ä»¶ç±»å‹** (0.5h)
```csharp
public enum AgentEventType
{
    MessageReceived,
    MessageProcessing,
    MessageProcessed,
    ToolCalling,
    ToolCalled,
    Error
}

public record AgentEvent(
    AgentEventType Type,
    string AgentName,
    object? Data,
    DateTime Timestamp);
```

2. **å®ç°ObservableAgent** (2h)
```csharp
public class ObservableAgent : AgentBase, IObservable<AgentEvent>
{
    private readonly Subject<AgentEvent> _eventSubject = new();
    private readonly List<IObserver<AgentEvent>> _observers = new();
    
    public override async Task<Msg> CallAsync(Msg message)
    {
        // å‘å¸ƒäº‹ä»¶ï¼šæ¥æ”¶æ¶ˆæ¯
        PublishEvent(AgentEventType.MessageReceived, message);
        
        try
        {
            // å‘å¸ƒäº‹ä»¶ï¼šå¼€å§‹å¤„ç†
            PublishEvent(AgentEventType.MessageProcessing, message);
            
            // å¤„ç†æ¶ˆæ¯
            var response = await ProcessMessageAsync(message);
            
            // å‘å¸ƒäº‹ä»¶ï¼šå¤„ç†å®Œæˆ
            PublishEvent(AgentEventType.MessageProcessed, response);
            
            return response;
        }
        catch (Exception ex)
        {
            // å‘å¸ƒäº‹ä»¶ï¼šé”™è¯¯
            PublishEvent(AgentEventType.Error, ex);
            throw;
        }
    }
    
    public IDisposable Subscribe(IObserver<AgentEvent> observer)
    {
        if (!_observers.Contains(observer))
        {
            _observers.Add(observer);
        }
        
        return _eventSubject.Subscribe(observer);
    }
    
    private void PublishEvent(AgentEventType type, object? data)
    {
        var agentEvent = new AgentEvent(
            type,
            Name,
            data,
            DateTime.UtcNow);
        
        _eventSubject.OnNext(agentEvent);
    }
    
    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _eventSubject.OnCompleted();
            _eventSubject.Dispose();
        }
        base.Dispose(disposing);
    }
}
```

3. **äº‹ä»¶è¿‡æ»¤å’Œè½¬æ¢** (1h)
```csharp
public static class ObservableAgentExtensions
{
    /// <summary>
    /// åªè®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶
    /// </summary>
    public static IObservable<AgentEvent> OfType(
        this IObservable<AgentEvent> source,
        AgentEventType eventType)
    {
        return source.Where(e => e.Type == eventType);
    }
    
    /// <summary>
    /// è®¢é˜…é”™è¯¯äº‹ä»¶
    /// </summary>
    public static IObservable<AgentEvent> Errors(
        this IObservable<AgentEvent> source)
    {
        return source.OfType(AgentEventType.Error);
    }
    
    /// <summary>
    /// è®¢é˜…æ¶ˆæ¯å¤„ç†å®Œæˆäº‹ä»¶
    /// </summary>
    public static IObservable<Msg> Messages(
        this IObservable<AgentEvent> source)
    {
        return source
            .OfType(AgentEventType.MessageProcessed)
            .Select(e => (Msg)e.Data!);
    }
}
```

4. **ä½¿ç”¨ç¤ºä¾‹** (0.5h)
```csharp
// åˆ›å»º ObservableAgent
var agent = ObservableAgent.Builder()
    .Name("ObservableAgent")
    .Model(model)
    .Build();

// è®¢é˜…æ‰€æœ‰äº‹ä»¶
agent.Subscribe(ev => 
{
    Console.WriteLine($"[{ev.Timestamp}] {ev.Type}: {ev.Data}");
});

// åªè®¢é˜…é”™è¯¯
agent.Errors().Subscribe(ev => 
{
    Console.WriteLine($"Error: {ev.Data}");
});

// åªè®¢é˜…æ¶ˆæ¯
agent.Messages().Subscribe(msg => 
{
    Console.WriteLine($"Message: {msg.Content}");
});

// ä½¿ç”¨LINQæ“ä½œç¬¦
agent
    .OfType(AgentEventType.MessageProcessed)
    .Buffer(TimeSpan.FromSeconds(1))  // æ¯ç§’æ‰¹å¤„ç†
    .Subscribe(events => 
    {
        Console.WriteLine($"Processed {events.Count} messages in last second");
    });
```

5. **å•å…ƒæµ‹è¯•** (2h)
```csharp
public class ObservableAgentTests
{
    [Fact]
    public async Task Subscribe_ReceivesEvents()
    {
        // Arrange
        var agent = ObservableAgent.Builder()
            .Model(new MockModel())
            .Build();
        
        var receivedEvents = new List<AgentEvent>();
        agent.Subscribe(receivedEvents.Add);
        
        // Act
        await agent.CallAsync(
            Msg.Builder().Role("user").Content("Test").Build());
        
        // Assert
        Assert.NotEmpty(receivedEvents);
        Assert.Contains(receivedEvents, 
            e => e.Type == AgentEventType.MessageReceived);
        Assert.Contains(receivedEvents, 
            e => e.Type == AgentEventType.MessageProcessed);
    }
    
    [Fact]
    public async Task OfType_FiltersEvents()
    {
        // Arrange
        var agent = ObservableAgent.Builder()
            .Model(new MockModel())
            .Build();
        
        var errorEvents = new List<AgentEvent>();
        agent.Errors().Subscribe(errorEvents.Add);
        
        // Act - æ­£å¸¸è°ƒç”¨
        await agent.CallAsync(
            Msg.Builder().Role("user").Content("Test").Build());
        
        // Assert - æ²¡æœ‰é”™è¯¯
        Assert.Empty(errorEvents);
    }
}
```

---

### ğŸ“¦ åŠŸèƒ½ç‚¹11-20ï¼šFormatter ç³»ç»Ÿ

#### [åŠŸèƒ½ç‚¹11] OpenAI Formatter å®Œæ•´å®ç° âœ…

**çŠ¶æ€**: å·²å®Œæˆï¼ˆStep 1.1ï¼‰  
**æ–‡ä»¶**: 
- `src/AgentScope.Core/Formatter/OpenAI/Dto/*`
- `src/AgentScope.Core/Formatter/OpenAI/OpenAIMessageConverter.cs`
- `src/AgentScope.Core/Formatter/OpenAI/OpenAIResponseParser.cs`
- `src/AgentScope.Core/Formatter/OpenAI/OpenAIBaseFormatter.cs`
- `src/AgentScope.Core/Formatter/OpenAI/OpenAIChatFormatter.cs`

**åŠŸèƒ½æ¸…å•**:
- âœ… OpenAI DTOæ¨¡å‹ï¼ˆRequest, Response, Message, Toolï¼‰
- âœ… å¤šæ¨¡æ€å†…å®¹æ”¯æŒï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ï¼‰
- âœ… å·¥å…·è°ƒç”¨æ ¼å¼åŒ–
- âœ… æµå¼å“åº”å¤„ç†
- âœ… æ‰€æœ‰OpenAI APIå‚æ•°æ”¯æŒ
- âœ… o1ç³»åˆ—ç‰¹å®šåŠŸèƒ½

---

#### [åŠŸèƒ½ç‚¹12] Anthropic Formatter å®ç°

**çŠ¶æ€**: å¾…å®ç°ï¼ˆStep 1.2ï¼‰  
**ä¼˜å…ˆçº§**: é«˜  
**å·¥æ—¶**: 1å¤©  
**ä¾èµ–**: IFormatteræ¥å£

**è®¾è®¡ç›®æ ‡**:
- æ”¯æŒAnthropic Claude Messages API
- ContentBlockæ•°ç»„æ ¼å¼
- Tool Use blocks
- Thinking blocksï¼ˆæ¨ç†å†…å®¹ï¼‰

**å®æ–½æ­¥éª¤**:

1. **åˆ›å»ºDTOæ¨¡å‹** (2h)

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/Dto/AnthropicContentBlock.cs`
```csharp
/// <summary>
/// Anthropic å†…å®¹å—åŸºç±»
/// </summary>
public abstract record AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public abstract string Type { get; }
}

/// <summary>
/// æ–‡æœ¬å†…å®¹å—
/// </summary>
public record TextBlock : AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public override string Type => "text";
    
    [JsonPropertyName("text")]
    public required string Text { get; init; }
}

/// <summary>
/// å›¾ç‰‡å†…å®¹å—
/// </summary>
public record ImageBlock : AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public override string Type => "image";
    
    [JsonPropertyName("source")]
    public required ImageSource Source { get; init; }
}

public record ImageSource(
    [property: JsonPropertyName("type")] string Type,  // "base64"
    [property: JsonPropertyName("media_type")] string MediaType,  // "image/png"
    [property: JsonPropertyName("data")] string Data);  // base64å­—ç¬¦ä¸²

/// <summary>
/// å·¥å…·ä½¿ç”¨å—
/// </summary>
public record ToolUseBlock : AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public override string Type => "tool_use";
    
    [JsonPropertyName("id")]
    public required string Id { get; init; }
    
    [JsonPropertyName("name")]
    public required string Name { get; init; }
    
    [JsonPropertyName("input")]
    public required object Input { get; init; }
}

/// <summary>
/// å·¥å…·ç»“æœå—
/// </summary>
public record ToolResultBlock : AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public override string Type => "tool_result";
    
    [JsonPropertyName("tool_use_id")]
    public required string ToolUseId { get; init; }
    
    [JsonPropertyName("content")]
    public required string Content { get; init; }
}

/// <summary>
/// æ€è€ƒå†…å®¹å—ï¼ˆClaudeç‰¹æœ‰ï¼‰
/// </summary>
public record ThinkingBlock : AnthropicContentBlock
{
    [JsonPropertyName("type")]
    public override string Type => "thinking";
    
    [JsonPropertyName("thinking")]
    public required string Thinking { get; init; }
}
```

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/Dto/AnthropicMessage.cs`
```csharp
public record AnthropicMessage(
    [property: JsonPropertyName("role")] string Role,  // "user" or "assistant"
    [property: JsonPropertyName("content")] List<AnthropicContentBlock> Content);
```

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/Dto/AnthropicRequest.cs`
```csharp
public record AnthropicRequest
{
    [JsonPropertyName("model")]
    public required string Model { get; init; }
    
    [JsonPropertyName("messages")]
    public required List<AnthropicMessage> Messages { get; init; }
    
    [JsonPropertyName("system")]
    public string? System { get; init; }
    
    [JsonPropertyName("max_tokens")]
    public required int MaxTokens { get; init; }
    
    [JsonPropertyName("temperature")]
    public double? Temperature { get; init; }
    
    [JsonPropertyName("top_p")]
    public double? TopP { get; init; }
    
    [JsonPropertyName("top_k")]
    public int? TopK { get; init; }
    
    [JsonPropertyName("tools")]
    public List<AnthropicTool>? Tools { get; init; }
    
    [JsonPropertyName("stream")]
    public bool Stream { get; init; }
}
```

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/Dto/AnthropicResponse.cs`
```csharp
public record AnthropicResponse
{
    [JsonPropertyName("id")]
    public required string Id { get; init; }
    
    [JsonPropertyName("type")]
    public required string Type { get; init; }  // "message"
    
    [JsonPropertyName("role")]
    public required string Role { get; init; }  // "assistant"
    
    [JsonPropertyName("content")]
    public required List<AnthropicContentBlock> Content { get; init; }
    
    [JsonPropertyName("model")]
    public required string Model { get; init; }
    
    [JsonPropertyName("stop_reason")]
    public string? StopReason { get; init; }  // "end_turn", "tool_use", etc.
    
    [JsonPropertyName("usage")]
    public required AnthropicUsage Usage { get; init; }
}

public record AnthropicUsage(
    [property: JsonPropertyName("input_tokens")] int InputTokens,
    [property: JsonPropertyName("output_tokens")] int OutputTokens);
```

2. **å®ç°MessageConverter** (2h)

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/AnthropicMessageConverter.cs`
```csharp
public static class AnthropicMessageConverter
{
    public static AnthropicMessage ConvertToMessage(Msg msg)
    {
        return msg.Role switch
        {
            "system" => throw new ArgumentException("System messages should be passed as 'system' parameter"),
            "user" => ConvertUserMessage(msg),
            "assistant" => ConvertAssistantMessage(msg),
            "tool" => ConvertToolMessage(msg),
            _ => throw new ArgumentException($"Unknown role: {msg.Role}")
        };
    }
    
    private static AnthropicMessage ConvertUserMessage(Msg msg)
    {
        var contentBlocks = new List<AnthropicContentBlock>();
        
        // æ–‡æœ¬å†…å®¹
        if (!string.IsNullOrEmpty(msg.Content))
        {
            contentBlocks.Add(new TextBlock { Text = msg.Content });
        }
        
        // å›¾ç‰‡å†…å®¹
        if (msg.Metadata?.TryGetValue("image_urls", out var imageUrls) == true)
        {
            foreach (var url in (List<string>)imageUrls)
            {
                // è½¬æ¢ä¸ºbase64
                var base64Data = ConvertImageToBase64(url);
                contentBlocks.Add(new ImageBlock
                {
                    Source = new ImageSource(
                        Type: "base64",
                        MediaType: "image/png",
                        Data: base64Data)
                });
            }
        }
        
        return new AnthropicMessage("user", contentBlocks);
    }
    
    private static AnthropicMessage ConvertAssistantMessage(Msg msg)
    {
        var contentBlocks = new List<AnthropicContentBlock>();
        
        // æ–‡æœ¬å†…å®¹
        if (!string.IsNullOrEmpty(msg.Content))
        {
            contentBlocks.Add(new TextBlock { Text = msg.Content });
        }
        
        // å·¥å…·è°ƒç”¨
        if (msg.Metadata?.TryGetValue("tool_calls", out var toolCalls) == true)
        {
            foreach (var toolCall in (List<object>)toolCalls)
            {
                // æå–å·¥å…·è°ƒç”¨ä¿¡æ¯
                var toolUseBlock = ExtractToolUseBlock(toolCall);
                contentBlocks.Add(toolUseBlock);
            }
        }
        
        return new AnthropicMessage("assistant", contentBlocks);
    }
    
    private static AnthropicMessage ConvertToolMessage(Msg msg)
    {
        // å·¥å…·ç»“æœ
        var toolResultBlock = new ToolResultBlock
        {
            ToolUseId = msg.Metadata?["tool_call_id"] as string ?? "",
            Content = msg.Content ?? ""
        };
        
        return new AnthropicMessage("user", new List<AnthropicContentBlock> { toolResultBlock });
    }
}
```

3. **å®ç°ResponseParser** (1.5h)

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/AnthropicResponseParser.cs`
```csharp
public static class AnthropicResponseParser
{
    public static ParsedResponse ParseResponse(AnthropicResponse response)
    {
        var textContent = ExtractTextContent(response);
        var toolCalls = ExtractToolUseCalls(response);
        var thinkingContent = ExtractThinkingContent(response);
        
        return new ParsedResponse
        {
            Content = textContent,
            ToolCalls = toolCalls,
            ThinkingContent = thinkingContent,
            StopReason = response.StopReason,
            Usage = new TokenUsage
            {
                InputTokens = response.Usage.InputTokens,
                OutputTokens = response.Usage.OutputTokens,
                TotalTokens = response.Usage.InputTokens + response.Usage.OutputTokens
            }
        };
    }
    
    private static string ExtractTextContent(AnthropicResponse response)
    {
        var textBlocks = response.Content
            .OfType<TextBlock>()
            .Select(b => b.Text);
        
        return string.Join("\n", textBlocks);
    }
    
    private static List<ToolCallInfo> ExtractToolUseCalls(AnthropicResponse response)
    {
        return response.Content
            .OfType<ToolUseBlock>()
            .Select(block => new ToolCallInfo
            {
                Id = block.Id,
                Name = block.Name,
                Arguments = JsonSerializer.Serialize(block.Input)
            })
            .ToList();
    }
    
    private static string? ExtractThinkingContent(AnthropicResponse response)
    {
        var thinkingBlocks = response.Content
            .OfType<ThinkingBlock>()
            .Select(b => b.Thinking);
        
        return thinkingBlocks.Any() 
            ? string.Join("\n", thinkingBlocks) 
            : null;
    }
}
```

4. **å®ç°AnthropicFormatter** (1.5h)

æ–‡ä»¶ï¼š`src/AgentScope.Core/Formatter/Anthropic/AnthropicFormatter.cs`
```csharp
public class AnthropicFormatter : IFormatter<AnthropicRequest, AnthropicResponse, AnthropicOptions>
{
    public AnthropicRequest Format(
        List<Msg> messages,
        AnthropicOptions options)
    {
        // æå–systemæ¶ˆæ¯
        var systemMessage = messages
            .FirstOrDefault(m => m.Role == "system");
        
        // è½¬æ¢å…¶ä»–æ¶ˆæ¯
        var anthropicMessages = messages
            .Where(m => m.Role != "system")
            .Select(AnthropicMessageConverter.ConvertToMessage)
            .ToList();
        
        // æ„å»ºè¯·æ±‚
        return new AnthropicRequest
        {
            Model = options.Model ?? "claude-3-opus-20240229",
            Messages = anthropicMessages,
            System = systemMessage?.Content,
            MaxTokens = options.MaxTokens ?? 4096,
            Temperature = options.Temperature,
            TopP = options.TopP,
            TopK = options.TopK,
            Tools = options.Tools?.Select(ConvertTool).ToList(),
            Stream = options.Stream
        };
    }
    
    public ParsedResponse Parse(AnthropicResponse response)
    {
        return AnthropicResponseParser.ParseResponse(response);
    }
    
    private AnthropicTool ConvertTool(ToolSchema tool)
    {
        return new AnthropicTool
        {
            Name = tool.Name,
            Description = tool.Description,
            InputSchema = tool.Parameters
        };
    }
}
```

5. **å•å…ƒæµ‹è¯•** (2h)
```csharp
public class AnthropicFormatterTests
{
    [Fact]
    public void Format_WithTextMessage_CreatesValidRequest()
    {
        // Arrange
        var formatter = new AnthropicFormatter();
        var messages = new List<Msg>
        {
            Msg.Builder().Role("user").Content("Hello").Build()
        };
        var options = new AnthropicOptions { Model = "claude-3-opus-20240229" };
        
        // Act
        var request = formatter.Format(messages, options);
        
        // Assert
        Assert.Single(request.Messages);
        Assert.Equal("user", request.Messages[0].Role);
        Assert.IsType<TextBlock>(request.Messages[0].Content[0]);
    }
    
    [Fact]
    public void Format_WithSystemMessage_SetsSystemParameter()
    {
        // Arrange
        var formatter = new AnthropicFormatter();
        var messages = new List<Msg>
        {
            Msg.Builder().Role("system").Content("You are helpful").Build(),
            Msg.Builder().Role("user").Content("Hello").Build()
        };
        var options = new AnthropicOptions();
        
        // Act
        var request = formatter.Format(messages, options);
        
        // Assert
        Assert.Equal("You are helpful", request.System);
        Assert.Single(request.Messages);  // systemä¸åœ¨messagesä¸­
    }
}
```

6. **éªŒæ”¶æ ‡å‡†**
- [ ] æ‰€æœ‰DTOç±»åˆ›å»ºå®Œæˆ
- [ ] MessageConverteræ”¯æŒæ‰€æœ‰æ¶ˆæ¯ç±»å‹
- [ ] ResponseParseræ­£ç¡®è§£æå“åº”
- [ ] AnthropicFormatterå®Œæ•´å®ç°
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ15+æµ‹è¯•ï¼‰
- [ ] ä¸Javaç‰ˆæœ¬åŠŸèƒ½å¯¹ç­‰éªŒè¯
- [ ] ä»£ç è¦†ç›–ç‡ >= 80%

---

## 6. åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šFormatterç³»ç»Ÿå®Œå–„ï¼ˆ3å¤©ï¼‰

**Step 1.2**: Anthropic Formatterï¼ˆ1å¤©ï¼‰ â³ å½“å‰
- åˆ›å»ºAnthropic DTOæ¨¡å‹
- å®ç°MessageConverterå’ŒParser
- å®ç°AnthropicFormatterä¸»ç±»
- å•å…ƒæµ‹è¯•

**Step 1.3**: DashScope Formatterï¼ˆ1å¤©ï¼‰
- åˆ›å»ºDashScope DTOæ¨¡å‹
- å®ç°Formatter
- å•å…ƒæµ‹è¯•

**å®Œæˆåè¿›åº¦**: 31/54 (57.4%)

### é˜¶æ®µ2ï¼šçœŸå®LLMé›†æˆï¼ˆ3-4å¤©ï¼‰

**Step 1.4**: Modelå®ç°ï¼ˆ3å¤©ï¼‰
- OpenAI Model with HTTP Client
- Anthropic Model
- Azure OpenAI support
- Transportå±‚æŠ½è±¡

**å®Œæˆåè¿›åº¦**: 35/54 (64.8%)

### é˜¶æ®µ3ï¼šPipelineç³»ç»Ÿï¼ˆ2-3å¤©ï¼‰

**Step 1.5**: PipelineåŸºç¡€ï¼ˆ2-3å¤©ï¼‰
- Sequential Pipeline
- Parallel Pipeline
- MsgHub
- Pipelineå·¥å…·ç±»

**å®Œæˆåè¿›åº¦**: 39/54 (72.2%)

### é˜¶æ®µ4ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ10-13å¤©ï¼‰

**Step 2.1-2.8**: 
- Planç®¡ç†ç³»ç»Ÿï¼ˆ5å¤©ï¼‰
- RAGç³»ç»Ÿï¼ˆ3å¤©ï¼‰
- Agentå˜ä½“ï¼ˆ2-3å¤©ï¼‰
- å…¶ä»–é«˜çº§åŠŸèƒ½ï¼ˆ2å¤©ï¼‰

**å®Œæˆåè¿›åº¦**: 47/54 (87%)

### é˜¶æ®µ5ï¼šæ‰©å±•åŠŸèƒ½ï¼ˆ11-17å¤©ï¼‰

**Step 3.1-3.10**:
- Tracingç³»ç»Ÿï¼ˆ3å¤©ï¼‰
- Interruptionå¤„ç†ï¼ˆ2å¤©ï¼‰
- Skillç³»ç»Ÿï¼ˆ2å¤©ï¼‰
- ä¸“ä¸šå·¥å…·ï¼ˆ2å¤©ï¼‰
- MCP/A2Aåè®®ï¼ˆ2-3å¤©ï¼‰
- å…¶ä»–æ‰©å±•ï¼ˆ2-4å¤©ï¼‰

**å®Œæˆåè¿›åº¦**: 54/54 (100%) ğŸ†

---

## 7. è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 7.1 åˆ›å»ºå‹æ¨¡å¼

#### Builderæ¨¡å¼
**ç”¨é€”**: Agentã€Messageåˆ›å»º

```csharp
var agent = EnhancedReActAgent.Builder()
    .Name("MyAgent")
    .Model(model)
    .Memory(memory)
    .AddTool(tool1)
    .AddTool(tool2)
    .MaxIterations(10)
    .Verbose(true)
    .Build();

var message = Msg.Builder()
    .Role("user")
    .Content("Hello")
    .Metadata("key", "value")
    .Build();
```

#### Factoryæ¨¡å¼
**ç”¨é€”**: Modelã€Formatteråˆ›å»º

```csharp
public interface IModelFactory
{
    IModel CreateModel(string provider, string modelName);
}

public class ModelFactory : IModelFactory
{
    public IModel CreateModel(string provider, string modelName)
    {
        return provider.ToLower() switch
        {
            "openai" => new OpenAIModel(modelName),
            "anthropic" => new AnthropicModel(modelName),
            "dashscope" => new DashScopeModel(modelName),
            _ => throw new ArgumentException($"Unknown provider: {provider}")
        };
    }
}
```

### 7.2 ç»“æ„å‹æ¨¡å¼

#### Adapteræ¨¡å¼
**ç”¨é€”**: ä¸åŒLLM APIé€‚é…

```csharp
public interface ILLMAdapter
{
    Task<string> GenerateAsync(string prompt);
}

public class OpenAIAdapter : ILLMAdapter
{
    private readonly HttpClient _client;
    
    public async Task<string> GenerateAsync(string prompt)
    {
        // é€‚é…OpenAI APIæ ¼å¼
        var request = new OpenAIRequest { Prompt = prompt };
        var response = await _client.PostAsJsonAsync("/completions", request);
        var result = await response.Content.ReadFromJsonAsync<OpenAIResponse>();
        return result.Text;
    }
}

public class AnthropicAdapter : ILLMAdapter
{
    private readonly HttpClient _client;
    
    public async Task<string> GenerateAsync(string prompt)
    {
        // é€‚é…Anthropic APIæ ¼å¼
        var request = new AnthropicRequest { Prompt = prompt };
        var response = await _client.PostAsJsonAsync("/complete", request);
        var result = await response.Content.ReadFromJsonAsync<AnthropicResponse>();
        return result.Completion;
    }
}
```

#### Decoratoræ¨¡å¼
**ç”¨é€”**: AgentåŠŸèƒ½å¢å¼º

```csharp
public class LoggingAgentDecorator : IAgent
{
    private readonly IAgent _inner;
    private readonly ILogger _logger;
    
    public async Task<Msg> CallAsync(Msg message)
    {
        _logger.LogInformation("Agent {Name} received: {Content}", 
            _inner.Name, message.Content);
        
        var response = await _inner.CallAsync(message);
        
        _logger.LogInformation("Agent {Name} responded: {Content}", 
            _inner.Name, response.Content);
        
        return response;
    }
}
```

### 7.3 è¡Œä¸ºå‹æ¨¡å¼

#### Observeræ¨¡å¼
**ç”¨é€”**: Hookç³»ç»Ÿ

```csharp
public interface IHook
{
    Task OnEventAsync(HookEvent hookEvent, object data);
}

public class HookManager
{
    private readonly Dictionary<HookEventType, List<IHook>> _hooks = new();
    
    public void RegisterHook(HookEventType eventType, IHook hook)
    {
        if (!_hooks.ContainsKey(eventType))
            _hooks[eventType] = new List<IHook>();
        
        _hooks[eventType].Add(hook);
    }
    
    public async Task TriggerAsync(HookEventType eventType, object data)
    {
        if (_hooks.TryGetValue(eventType, out var hooks))
        {
            foreach (var hook in hooks)
            {
                await hook.OnEventAsync(
                    new HookEvent(eventType, data), data);
            }
        }
    }
}
```

#### Strategyæ¨¡å¼
**ç”¨é€”**: Formatteré€‰æ‹©

```csharp
public interface IFormatterStrategy
{
    bool CanHandle(string provider);
    IFormatter GetFormatter(string provider);
}

public class FormatterStrategy : IFormatterStrategy
{
    public bool CanHandle(string provider)
    {
        return provider switch
        {
            "openai" or "anthropic" or "dashscope" => true,
            _ => false
        };
    }
    
    public IFormatter GetFormatter(string provider)
    {
        return provider switch
        {
            "openai" => new OpenAIFormatter(),
            "anthropic" => new AnthropicFormatter(),
            "dashscope" => new DashScopeFormatter(),
            _ => throw new ArgumentException($"Unsupported provider: {provider}")
        };
    }
}
```

#### Template Methodæ¨¡å¼
**ç”¨é€”**: AgentåŸºç±»

```csharp
public abstract class AgentBase : IAgent
{
    // æ¨¡æ¿æ–¹æ³•
    public async Task<Msg> CallAsync(Msg message)
    {
        // 1. å‰ç½®å¤„ç†
        await PreProcessAsync(message);
        
        // 2. è§¦å‘Hook
        await TriggerHooksAsync(HookEvent.PreReasoning, message);
        
        // 3. æ ¸å¿ƒå¤„ç†ï¼ˆå­ç±»å®ç°ï¼‰
        var response = await ProcessMessageAsync(message);
        
        // 4. è§¦å‘Hook
        await TriggerHooksAsync(HookEvent.PostReasoning, response);
        
        // 5. åç½®å¤„ç†
        await PostProcessAsync(response);
        
        return response;
    }
    
    protected virtual Task PreProcessAsync(Msg message)
    {
        // é»˜è®¤å®ç°ï¼šæ·»åŠ åˆ°å†…å­˜
        return _memory.AddAsync(message);
    }
    
    protected abstract Task<Msg> ProcessMessageAsync(Msg message);
    
    protected virtual Task PostProcessAsync(Msg response)
    {
        // é»˜è®¤å®ç°ï¼šæ·»åŠ åˆ°å†…å­˜
        return _memory.AddAsync(response);
    }
}
```

---

## 8. è´¨é‡ä¿è¯ç­–ç•¥

### 8.1 æµ‹è¯•ç­–ç•¥

#### 8.1.1 å•å…ƒæµ‹è¯•ï¼ˆ80%+è¦†ç›–ç‡ï¼‰

**æµ‹è¯•æ¡†æ¶**: xUnit  
**Mocking**: Moq  
**æ–­è¨€**: FluentAssertions

**æµ‹è¯•è§„èŒƒ**:
```csharp
[Fact]
public async Task MethodName_Condition_ExpectedBehavior()
{
    // Arrangeï¼ˆå‡†å¤‡ï¼‰
    var mockModel = new Mock<IModel>();
    mockModel.Setup(m => m.GenerateAsync(It.IsAny<string>()))
        .ReturnsAsync("Response");
    
    var agent = new CallableAgent(mockModel.Object);
    var message = Msg.Builder().Role("user").Content("Test").Build();
    
    // Actï¼ˆæ‰§è¡Œï¼‰
    var response = await agent.CallAsync(message);
    
    // Assertï¼ˆæ–­è¨€ï¼‰
    response.Should().NotBeNull();
    response.Role.Should().Be("assistant");
    response.Content.Should().NotBeEmpty();
    
    mockModel.Verify(m => m.GenerateAsync(It.IsAny<string>()), Times.Once());
}
```

**æµ‹è¯•è¦†ç›–è¦æ±‚**:
- æ¯ä¸ªå…¬å…±æ–¹æ³•è‡³å°‘1ä¸ªæµ‹è¯•
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- å¼‚å¸¸æƒ…å†µæµ‹è¯•
- å¹¶å‘åœºæ™¯æµ‹è¯•

#### 8.1.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
```csharp
public class AgentIntegrationTests
{
    [Fact]
    public async Task Agent_WithRealDatabase_PersistsMessages()
    {
        // Arrange
        var tempDbPath = Path.GetTempFileName();
        var memory = new SqliteMemory(tempDbPath);
        var agent = CallableAgent.Builder()
            .Model(new MockModel())
            .Memory(memory)
            .Build();
        
        // Act
        await agent.CallAsync(
            Msg.Builder().Role("user").Content("Test").Build());
        
        // Assert
        var messages = await memory.GetAllAsync();
        messages.Should().HaveCount(2);  // user + assistant
        
        // Cleanup
        memory.Dispose();
        File.Delete(tempDbPath);
    }
}
```

#### 8.1.3 ç«¯åˆ°ç«¯æµ‹è¯•

**æµ‹è¯•å®Œæ•´å·¥ä½œæµ**:
```csharp
[Fact]
public async Task CompleteWorkflow_WithTools_WorksEndToEnd()
{
    // Arrange
    var agent = EnhancedReActAgent.Builder()
        .Name("TestAgent")
        .Model(new MockModel())
        .AddTool(new CalculatorTool())
        .Build();
    
    // Act
    var response = await agent.CallAsync(
        Msg.Builder()
            .Role("user")
            .Content("Calculate 123 + 456")
            .Build());
    
    // Assert
    response.Content.Should().Contain("579");
}
```

### 8.2 ä»£ç è´¨é‡

#### 8.2.1 é™æ€åˆ†æ

**å·¥å…·**: 
- StyleCop Analyzers
- Roslynator
- SonarAnalyzer.CSharp

**é…ç½®**: `.editorconfig`
```ini
[*.cs]
# å‘½åè§„èŒƒ
dotnet_naming_rule.async_methods_must_end_with_async.severity = error
dotnet_naming_rule.async_methods_must_end_with_async.symbols = async_methods
dotnet_naming_rule.async_methods_must_end_with_async.style = async_suffix

# ä»£ç é£æ ¼
csharp_prefer_braces = true:error
csharp_using_directive_placement = outside_namespace:error
dotnet_sort_system_directives_first = true
```

#### 8.2.2 ä»£ç å®¡æŸ¥æ¸…å•

**æ¶æ„å®¡æŸ¥**:
- [ ] ç¬¦åˆSOLIDåŸåˆ™
- [ ] ä¾èµ–æ–¹å‘æ­£ç¡®
- [ ] æ²¡æœ‰å¾ªç¯ä¾èµ–
- [ ] æ¥å£èŒè´£å•ä¸€

**ä»£ç å®¡æŸ¥**:
- [ ] å‘½åæ¸…æ™°æœ‰æ„ä¹‰
- [ ] æ²¡æœ‰é­”æ³•æ•°å­—
- [ ] å¼‚å¸¸å¤„ç†å®Œæ•´
- [ ] æ—¥å¿—è®°å½•å……åˆ†
- [ ] æ³¨é‡Šæ¸…æ™°å‡†ç¡®

**æ€§èƒ½å®¡æŸ¥**:
- [ ] æ²¡æœ‰N+1æŸ¥è¯¢
- [ ] ä½¿ç”¨å¼‚æ­¥I/O
- [ ] é¿å…ä¸å¿…è¦çš„åˆ†é…
- [ ] ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„

### 8.3 æŒç»­é›†æˆ

#### 8.3.1 GitHub Actionså·¥ä½œæµ

æ–‡ä»¶ï¼š`.github/workflows/build.yml`
```yaml
name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    - name: Test
      run: dotnet test --no-build --verbosity normal --configuration Release
    
    - name: Code Coverage
      run: |
        dotnet test --collect:"XPlat Code Coverage"
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator "-reports:**/coverage.cobertura.xml" "-targetdir:coverage" "-reporttypes:Html"
    
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/Cobertura.xml
```

#### 8.3.2 è´¨é‡é—¨ç¦

**è¦æ±‚**:
- âœ… æ„å»ºæˆåŠŸï¼ˆæ— è­¦å‘Šï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… ä»£ç è¦†ç›–ç‡ >= 80%
- âœ… æ— ä¸¥é‡ä»£ç å¼‚å‘³
- âœ… æ— å®‰å…¨æ¼æ´

---

## 9. é£é™©ç®¡ç†

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| APIå˜æ›´ | ä¸­ | é«˜ | ç‰ˆæœ¬é”å®šï¼Œé€‚é…å™¨æ¨¡å¼éš”ç¦» |
| æ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | æ€§èƒ½æµ‹è¯•ï¼Œä¼˜åŒ–å…³é”®è·¯å¾„ |
| å¹¶å‘bug | ä½ | é«˜ | çº¿ç¨‹å®‰å…¨è®¾è®¡ï¼Œå¹¶å‘æµ‹è¯• |
| å†…å­˜æ³„æ¼ | ä½ | ä¸­ | IDisposableæ¨¡å¼ï¼Œå†…å­˜åˆ†æ |

### 9.2 è¿›åº¦é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| æ—¶é—´ä¼°ç®—åå·® | ä¸­ | ä¸­ | ç¼“å†²æ—¶é—´ï¼ŒæŒç»­è·Ÿè¸ª |
| éœ€æ±‚å˜æ›´ | ä¸­ | ä¸­ | è¿­ä»£å¼€å‘ï¼Œå¿«é€Ÿå“åº” |
| æŠ€æœ¯éš¾é¢˜ | ä½ | é«˜ | ç ”ç©¶æ—¶é—´ï¼Œå¤‡é€‰æ–¹æ¡ˆ |
| èµ„æºä¸è¶³ | ä½ | ä¸­ | ä¼˜å…ˆçº§ç®¡ç†ï¼Œæ¸è¿›å®æ–½ |

### 9.3 è´¨é‡é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| æµ‹è¯•è¦†ç›–ä¸è¶³ | ä¸­ | é«˜ | å¼ºåˆ¶80%è¦†ç›–ç‡è¦æ±‚ |
| æ–‡æ¡£ç¼ºå¤± | ä¸­ | ä¸­ | ä¸ä»£ç åŒæ­¥æ›´æ–°æ–‡æ¡£ |
| æŠ€æœ¯å€ºç´¯ç§¯ | ä¸­ | é«˜ | é›¶æŠ€æœ¯å€ºç­–ç•¥ï¼ŒåŠæ—¶é‡æ„ |

---

## 10. é™„å½•

### 10.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| Agent | æ™ºèƒ½ä½“ï¼Œèƒ½å¤Ÿè‡ªä¸»æ‰§è¡Œä»»åŠ¡çš„å®ä½“ |
| ReAct | Reasoning + Actingï¼Œæ¨ç†å’Œè¡ŒåŠ¨ç»“åˆçš„Agentæ¨¡å¼ |
| Hook | é’©å­ï¼Œåœ¨ç‰¹å®šæ—¶åˆ»è§¦å‘çš„å›è°ƒæœºåˆ¶ |
| Formatter | æ ¼å¼åŒ–å™¨ï¼Œå°†æ¶ˆæ¯è½¬æ¢ä¸ºç‰¹å®šLLM APIæ ¼å¼ |
| Pipeline | ç®¡é“ï¼Œå¤šä¸ªAgentçš„ç¼–æ’å’Œæ‰§è¡Œæµç¨‹ |
| Memory | å†…å­˜ï¼Œå­˜å‚¨å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡ |
| Tool | å·¥å…·ï¼ŒAgentå¯è°ƒç”¨çš„å¤–éƒ¨åŠŸèƒ½ |
| RAG | Retrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆ |

### 10.2 ç¼©å†™å¯¹ç…§

| ç¼©å†™ | å…¨ç§° |
|------|------|
| LLM | Large Language Modelï¼Œå¤§è¯­è¨€æ¨¡å‹ |
| API | Application Programming Interfaceï¼Œåº”ç”¨ç¨‹åºæ¥å£ |
| DTO | Data Transfer Objectï¼Œæ•°æ®ä¼ è¾“å¯¹è±¡ |
| ORM | Object-Relational Mappingï¼Œå¯¹è±¡å…³ç³»æ˜ å°„ |
| CI/CD | Continuous Integration/Continuous Deployment |
| TDD | Test-Driven Developmentï¼Œæµ‹è¯•é©±åŠ¨å¼€å‘ |
| SOLID | é¢å‘å¯¹è±¡è®¾è®¡çš„5ä¸ªåŸåˆ™ |

### 10.3 å‚è€ƒèµ„æº

**é¡¹ç›®æ–‡æ¡£**:
- README.md - é¡¹ç›®æ¦‚è§ˆ
- CONTRIBUTING.md - è´¡çŒ®æŒ‡å—
- FEATURE_COMPARISON.md - åŠŸèƒ½å¯¹æ¯”

**æŠ€æœ¯æ–‡æ¡£**:
- .NET 9.0 æ–‡æ¡£
- Entity Framework Core æ–‡æ¡£
- xUnit æ–‡æ¡£

**Javaæºç **:
- agentscope-java GitHubä»“åº“
- /tmp/agentscope-java æœ¬åœ°å…‹éš†

---

## ğŸ¯ æ€»ç»“

æœ¬ç ”å‘è®¡åˆ’æ¶µç›–äº†AgentScope.NETé¡¹ç›®çš„æ‰€æœ‰æ–¹é¢ï¼š

**å®Œæ•´æ€§**:
- âœ… 54ä¸ªåŠŸèƒ½ç‚¹è¯¦ç»†è§„åˆ’
- âœ… è®¾è®¡æ€æƒ³å’Œæ¶æ„æ¸…æ™°
- âœ… å®æ–½æ­¥éª¤å¯æ‰§è¡Œ

**å¯æ“ä½œæ€§**:
- âœ… æ¯ä¸ªåŠŸèƒ½ç»†åŒ–åˆ°æ–‡ä»¶çº§
- âœ… ä»£ç ç¤ºä¾‹å’Œæ¨¡æ¿
- âœ… æµ‹è¯•è§„èŒƒå’ŒéªŒæ”¶æ ‡å‡†

**è´¨é‡ä¿è¯**:
- âœ… è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µ
- âœ… æµ‹è¯•ç­–ç•¥ï¼ˆ80%+è¦†ç›–ï¼‰
- âœ… CI/CDå’Œè´¨é‡é—¨ç¦

**é¡¹ç›®ç®¡ç†**:
- âœ… åˆ†é˜¶æ®µå®æ–½è®¡åˆ’
- âœ… æ—¶é—´ä¼°ç®—å’Œé‡Œç¨‹ç¢‘
- âœ… é£é™©è¯†åˆ«å’Œç¼“è§£

---

**å‡†å¤‡å¼€å§‹å®æ–½ï¼è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å®Œæˆå…¨éƒ¨54ä¸ªåŠŸèƒ½ç‚¹ï¼** ğŸš€ğŸ’ª

**å½“å‰è¿›åº¦**: 29/54 (53.7%)  
**ä¸‹ä¸€æ­¥**: Step 1.2 - Anthropic Formatter  
**ç»ˆæç›®æ ‡**: 54/54 (100%) ğŸ†
